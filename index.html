<!doctype html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="http://localhost:8080/webgis/libs/v6.15.1/css/ol.css" type="text/css">
        <link rel="stylesheet" href="http://localhost:8080/webgis/libs/v6.15.1/examples/resources/layout.css" type="text/css">
	    <link rel="stylesheet" href="http://localhost:8080/webgis/libs/ol-layerswitcher-master/dist/ol-layerswitcher.css" />
        <link rel="stylesheet" href="http://localhost:8080/webgis/libs/bootstrap.min.css">
        <link rel="stylesheet" href="http://localhost:8080/webgis/libs/jquery-ui-1.13.2/jquery-ui.css">
	  
        <script src="http://localhost:8080/webgis/libs/v6.15.1/build/ol.js"></script>
	    <script src="http://localhost:8080/webgis/libs/ol-layerswitcher-master/dist/ol-layerswitcher.js"></script>
        <script type="text/javascript" src="http://localhost:8080/webgis/libs/bootstrap.min.js"></script>
        <script src="http://localhost:8080/webgis/libs/jquery-ui-1.13.2/external/jquery/jquery.js"></script>
        <script src="http://localhost:8080/webgis/libs/jquery-ui-1.13.2/jquery-ui.js"></script>

        <style>
            html,body {
                height: 100%;
                padding: 0;
                margin: 0;
                font-family: arial;
            }
            
            #title {
                position: absolute;
                left: 50%;
                width: 100%;
                height: 3%;	   
                top: 1%
            }
            
            #map {
                position: absolute;
                top: 4%;
                width: 80%;
				left: 20%;
                height: 96%;
                overflow: scroll;
                border: 0.5px solid #4CAF50;	   
            }
			
			#left {
				width: 25%;
				left: 50px;
				top: 0%;
			}
            
            #wms_layers_btn {
                position: absolute;
                z-index:500;
                top: 1%;
                right: 10%;
                border-color: #cccccc;
                background-color: #ffffff;
                color: #4CAF50;
                font-weight: bold;
            }

            #clear_btn{
                position: absolute;
                z-index:500;
                top: 1%;
                right: 3%;
                border-color: #cccccc;
                background-color: #ffffff;
                color: #4CAF50;
                font-weight: bold;
            }
			
			.btn-success {
				background-color: #4CAF50;
				border-color: #4CAF50;
			}
            
            #data {
                width: 60%; 
            }
                
            #table_data {
                position: absolute;
                bottom: 0%;
                overflow: scroll;
                left: 20%;
                right: 0%;
                height: 0%;
                border: 1px solid #4CAF50;
            }
            
            #table {
                white-space:nowrap;
                grid-template-areas:"head-fixed" "body-scrollable";
            }
                
            #showData {
                overflow: auto;
                width: 100%;
            }

            #table th {
                position: relative;
                top: 0%;
                background-color: #4CAF50;
            }
                
            #table_wms_layers {
                white-space:nowrap;
                border-collapse: separate;
                font-family: arial;
                font-size:14px;
            }

            #secondattributes, #secondoperator, #secondvalue {
                visibility: hidden;
            }
            
            #table_wms_layers th {
                position: relative;
                top: 0;
                background-color: #4CAF50;
            }

            .ol-mouse-position {
                top:97%;
                right:20%;
                position:absolute;
                font-weight: bold;
            }
        
            .tab-content {
                position: relative;
                top:1%;
                width:85%;
                height:85%;
            }
			
			.form-control {
				position: relative;
				top: 0px;
				width: 85%;
			}
        
            .ol-popup {
                position: absolute;
                background-color: white;
                -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
                filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
                padding: 24px;
                border-radius: 10px;
                border: 1px solid #cccccc;
                bottom: 10px;
                left: -50px;
                min-width: 280px;
                z-index: 99999;
            }

            .ol-popup:after, .ol-popup:before {
                top: 100%;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .ol-popup:after {
                border-top-color: white;
                border-width: 10px;
                left: 48px;
                margin-left: -10px;
            }

            .ol-popup:before {
                border-top-color: #cccccc;
                border-width: 11px;
                left: 48px;
                margin-left: -11px;
            }

            .ol-popup-closer {
                text-decoration: none;
                position: absolute;
                top: 2px;
                right: 8px;
                z-index: -1;
            }

            .ol-popup-closer:after {
                content: "X";
                color: palevioletred;
            }
			
			.query-spatial {
				z-index: 999;
                padding: 2px 4px;
                border: 1px solid grey;
                position: absolute;
                top: 4%;
                height: 50%;
                overflow: scroll;
                width: 20%; 
                left: 0%;
                background-color: #ffffff;
                font-weight: bold;
                opacity: 0.75;
			}
			
			.query-spatial:hover {
                z-index: 999;
                padding: 2px 4px;
                border: 1px solid grey;
                position: absolute;
                top: 4%;
                height: 50%;
                overflow: scroll;
                width:20%; 
                left:0%;
                background-color: #ffffff;
                font-weight: bold;
                opacity: 1.0;
            }

            #getinfo {
                position: absolute;
                z-index:9999;
                top: 1%;
                left: 5%;
            }

            #legend {
                z-index: 999;
                padding: 2px 4px;
                border: 1px solid grey;
                position: absolute;
                bottom: 0%;
                height: 46%;
                overflow: scroll;
                width: 20%; 
                left: 0%;
                background-color: #ffffff;
                font-weight: bold;
                opacity: 0.75;
	        }

            #legend:hover {
                z-index: 999;
                padding: 2px 4px;
                border: 1px solid grey;
                position: absolute;
                bottom: 0%;
                height: 46%;
                overflow: scroll;
                width:20%; 
                left:0%;
                background-color: #ffffff;
                font-weight: bold;
                opacity: 1.0;
            }

            .modal {
                overflow: hidden;
            }

            .modal-dialog {
                height:300px;
            }

            .modal-header {
                height:30px;
                padding: 20px;
                background-color:#18456b;
                color:white;
            }

            .modal-title {
                margin-top:-10px;
                font-size:16px;
            }

            .modal-header .close {
                margin-top:-10px;
                color:#fff;
            }

            .modal-body {
                color:#888;
                padding: 5px 35px 20px;
            }

            .modal-body h3 {
                text-align: center;
            }

            .modal-body p {
                padding-top:10px;
                font-size: 1.1em;
            }
        </style>

        <title>GIS</title>
    </head>

    <body>
        <div id="title"> 
            <h5><b>Project GIS</b></h5>
        </div>
	    <div id="map"> 
            <form id="getinfo">
                <select id="getinfotype">
                    <option selected disabled value="">Choose the attribute display option</option>
                    <option value="activate_getinfo">Activate GetFeatureinfo</option>
                    <option value="deactivate_getinfo">Deactivate GetFeatureinfo</option>
                </select>
            </form>
            <button onclick="clear_all()" id = "clear_btn">Clear</button>
            <button onclick="wms_layers()" id ="wms_layers_btn">Available WMS Layers</button>
	    </div>
	    <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
	    <div id="info">&nbsp;</div>
		<div id="legend"></div>
		<div class="query-spatial">
			<div id="form">
				<label for="layer">Select Layer</label>
				<select class="form-control" id="layer" name="layer">
					<option value="" selected disabled>Select Layer</option>
				</select>
				<br>
				<label for="attributes">Select attribute</label>
				<select class="form-control" id="attributes" name="attributes">
					<option value="" selected disabled>Select Attributes</option>
				</select>
				<br>
				<label for="operator">Select operator</label>
				<select class="form-control" id="operator" name="operator">
					<option value="" selected disabled>Select operator</option>
				</select>
				<br>
				<label for="value">Enter value</label>
				<input type="text" class="form-control" id="value" name="value">
				<br>
				<label for="attributestwo">Select second attribute</label>
				<select class="form-control" id="attributestwo" name="attributestwo">
					<option value="" selected disabled>Select Attributes</option>
				</select>
				<br>
				<label for="operatortwo">Select second operator</label>
				<select class="form-control" id="operatortwo" name="operatortwo">
					<option value="" selected disabled>Select operator</option>
				</select>
				<br>
				<label for="valuetwo">Enter second value</label>
				<input type="text" class="form-control" id="valuetwo" name="valuetwo">
				<br>
				<button class="btn btn-success" onclick="query()">Load Query</button>
			</div>
            <br/><br/>
            <div id="form">
				<label for="secondlayer">Select Second Layer</label>
				<select class="form-control" id="secondlayer" name="secondlayer">
					<option value="" selected disabled>Select Layer</option>
				</select>
				<!-- <br> -->
				<!-- <label for="secondattributes">Select attribute</label> -->
				<select class="form-control" id="secondattributes" name="secondattributes">
					<option value="" selected disabled>Select Attributes</option>
				</select>
				<!-- <br>
				<label for="secondoperator">Select operator</label> -->
				<select class="form-control" id="secondoperator" name="secondoperator">
					<option value="" selected disabled>Select operator</option>
				</select>
				<!-- <br>
				<label for="secondvalue">Enter Value</label> -->
				<input type="text" class="form-control" id="secondvalue" name="secondvalue">
				<!-- <br> -->
				<button class="btn btn-success" onclick="query_multiple()">Query For Multiple Layers</button>
			</div>
		</div>
        <div id="table_data"></div>
        <div id="wms_layers_window" title="Available WMS Layers" style="display:none"></div>
        <table id="table_wms_layers" class="table-bordered"></table>

        <script type="text/javascript">
            var map, geojson, layer_name, layerSwitcher, featureOverlay; 
            var container, content, closer;
            var container = document.getElementById('popup');
            var content = document.getElementById('popup-content');
            var closer = document.getElementById('popup-closer');
            var overlay = new ol.Overlay({
                element: container,
                autoPan: true,
                autoPanAnimation: {
                duration: 250 }
            });

            closer.onclick = function() {
                overlay.setPosition(undefined);
                closer.blur();
                return false;
            };
            
            var view = new ol.View({
                projection: 'EPSG:4326',
                center: [20.7,44.5],
                zoom: 7,
                
                });
                var view_ov = new ol.View({
                projection: 'EPSG:4326',
                center: [20.7,44.5],
                zoom: 7,
                });
		
            var base = new ol.layer.Group({
                'title': 'Maps',
                layers: [
                        new ol.layer.Tile({
                        title: 'OSM',
                        type: 'base',
                        visible: true,
                        source: new ol.source.OSM()
                    })
                ]
            });
		   
            var OSM = new ol.layer.Tile({
                source: new ol.source.OSM(),
                type: 'base',
                title: 'OSM',
            });
		  
            var overlays = new ol.layer.Group({
                'title': 'Overlays',
                layers: [
                new ol.layer.Image({
                title: 'restaurants_long_streets',
                source: new ol.source.ImageWMS({
                        url: 'http://localhost:8080/geoserver/wms',
                        params: {'LAYERS': 'serbia:restaurants_long_streets'},
                        ratio: 1,
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Image({
                title: 'parking_lots',
                source: new ol.source.ImageWMS({
                        url: 'http://localhost:8080/geoserver/wms',
                        params: {'LAYERS': 'serbia:parking_lots'},
                        ratio: 1,
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Image({
                title: 'attractions_near_bus_stations',
                source: new ol.source.ImageWMS({
                        url: 'http://localhost:8080/geoserver/wms',
                        params: {'LAYERS': 'serbia:attractions_near_bus_stations'},
                        ratio: 1,
                        serverType: 'geoserver'
                    })
                })]
            }); 
	  
            var map = new ol.Map({
                target: 'map',
                view: view,
                overlays: [overlay]
            });
	  
            map.addLayer(base);
            map.addLayer(overlays);
	  
            var new_layer = new ol.layer.Image({
                title: 'big-streets',
                source: new ol.source.ImageWMS({
                        url: 'http://localhost:8080/geoserver/wms',
                        params: {'LAYERS': 'serbia:planet_osm_street_mv_filter'},
                        ratio: 1,
                        serverType: 'geoserver'
                    })
            });
            //	overlays.getLayers().push(new_layer);
            //	map.addLayer(new_layer);
	  
        var mouse_position = new ol.control.MousePosition();
        map.addControl(mouse_position);
	
        var full_sc = new ol.control.FullScreen({label:'F'});
        map.addControl(full_sc);
        
        var zoom = new ol.control.Zoom({zoomInLabel:'+', zoomOutLabel:'-'});
        map.addControl(zoom);
        
        var slider = new ol.control.ZoomSlider();
        map.addControl(slider);

        var zoom_ex = new ol.control.ZoomToExtent({
            extent:[13.97, 37.88, 27.24, 51.37]
        });
        map.addControl(zoom_ex);
		
        var layerSwitcher = new ol.control.LayerSwitcher({
            activationMode: 'click',
            startActive: true,
            tipLabel: 'Layers',
            groupSelectStyle: 'children',
            collapseTipLabel: 'Collapse layers',
        });
        map.addControl(layerSwitcher);

        function legend () {
            $('#legend').empty();
            var no_layers = overlays.getLayers().get('length');
            var head = document.createElement("h4");
            var element = document.getElementById("legend");
            element.appendChild(head);
            var ar = [];
            for (var i = 0; i < no_layers; i++) {
                ar.push("http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.3.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+overlays.getLayers().item(i).get('title'));
            }
            for (i = 0; i < no_layers; i++) {
                var head = document.createElement("p");
                var txt = document.createTextNode(overlays.getLayers().item(i).get('title'));
                head.appendChild(txt);
                var element = document.getElementById("legend");
                element.appendChild(head);
                var img = new Image();
                img.src = ar[i];
                var src = document.getElementById("legend");
                src.appendChild(img);
            }
	    }
	 
	    legend();
	
	    function getinfo(evt) {
	        var coordinate = evt.coordinate;
	        var viewResolution = /** @type {number} */ (view.getResolution());
	        $("#popup-content").empty();

            document.getElementById('info').innerHTML = '';
            var no_layers = overlays.getLayers().get('length');
            var url = new Array();
            var wmsSource = new Array();
            var layer_title = new Array();

	        for (var i = 0; i < no_layers; i++) {
	            var visibility = overlays.getLayers().item(i).getVisible();
                if (visibility == true){
                    layer_title[i] = overlays.getLayers().item(i).get('title');
                    wmsSource[i] = new ol.source.ImageWMS({
                        url: 'http://localhost:8080/geoserver/wms',
                        params: {'LAYERS': layer_title[i]},
                        serverType: 'geoserver',
                        crossOrigin: 'anonymous'
                    });

                    url[i] = wmsSource[i].getFeatureInfoUrl(
                    evt.coordinate, viewResolution, 'EPSG:4326',
                    {'INFO_FORMAT': 'text/html'});

                    $.get(url[i], function (data) {
                        $("#popup-content").append(data);
                        overlay.setPosition(coordinate);
                        layerSwitcher.renderPanel();
                    });
			    }
	        }
        }

		getinfotype.onchange = function() {
		    map.removeInteraction(draw);
            if (vectorLayer) {
                vectorLayer.getSource().clear();
            }
            map.removeOverlay(helpTooltip);
		
		    if (getinfotype.value == 'activate_getinfo') {
	            map.on('singleclick', getinfo);
	        } else if (getinfotype.value == 'deactivate_getinfo') {
	            map.un('singleclick', getinfo);
	            overlay.setPosition(undefined);
                closer.blur();
	        }
        };
		
		var source = new ol.source.Vector();
	    var vectorLayer = new ol.layer.Vector({
            source: source,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 0.2)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffcc33',
                    width: 2
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: '#ffcc33'
                    })
                })
            })
        });
        map.addLayer(vectorLayer);

        var helpTooltip;
        var draw; 

	    function wms_layers() {
            $(function() { $( "#wms_layers_window" ).dialog({
                    height: 400,
                    width: 800,
                    modal: true
                });
                $( "#wms_layers_window" ).show();
            });
 
            $(document).ready(function() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:8080/geoserver/wms?request=getCapabilities",
                    dataType: "xml",
                    success: function(xml){
                        $('#table_wms_layers').empty();
                            console.log("here");
                            $('<tr></tr>').html('<th>Name</th><th>Title</th><th>Abstract</th>').appendTo('#table_wms_layers');
                            $(xml).find('Layer').find('Layer').each(function() {
                                var name = $(this).children('Name').text();
                                var title = $(this).children('Title').text();  
                                var abst = $(this).children('Abstract').text();
                                $('<tr></tr>').html('<td>' +name+ '</td><td>' +title+ '</td><td>' +abst+ '</td>').appendTo('#table_wms_layers');
                            });
                            addRowHandlers();
                    }
                });
            });
	  
            var divContainer = document.getElementById("wms_layers_window");
            var table_layers = document.getElementById("table_wms_layers");
            divContainer.innerHTML = "";
            divContainer.appendChild(table_layers);
            $( "#wms_layers_window" ).show();
            var add_map_btn = document.createElement("BUTTON");
            add_map_btn.setAttribute("id", "add_map_btn");
            add_map_btn.innerHTML = "Add Layer";
            add_map_btn.setAttribute("onclick", "add_layer()");
            divContainer.appendChild(add_map_btn);   

            function addRowHandlers() {
                var rows = document.getElementById("table_wms_layers").rows;
                var table = document.getElementById('table_wms_layers');
                var heads = table.getElementsByTagName('th');
                var col_no;
                for (var i = 0; i < heads.length; i++) {
                    var head = heads[i];
                    if (head.innerHTML == 'Name') {
                        col_no = i+1; 
                    }
                }
                for (i = 0; i < rows.length; i++) {
                    $("#table_wms_layers td").each(function() {
                        $(this).parent("tr").css("cursor", "pointer");
                    });
                    rows[i].onclick = function(){ return function() {
                        $(function() {
                            $("#table_wms_layers td").each(function() {
                                $(this).parent("tr").css("background-color", "white");
                            });
                        });
                        var cell = this.cells[col_no-1];
                        layer_name = cell.innerHTML;
                        $(document).ready(function () {
                            $("#table_wms_layers td:nth-child("+col_no+")").each(function () {
                                if ($(this).text() == layer_name) {
                                    $(this).parent("tr").css("background-color", "grey"); 
                                }
                            });
                        });
                    };}
                    (rows[i]);
                }
            }
        }

        function add_layer() {
            var name = layer_name.split(":");			
            var consists = false;
            console.log(overlays.getLayers().get('length'))
            console.log(name)
            for(var i=0; i<overlays.getLayers().get('length'); i++) {
                console.log(overlays.getLayers().item(i).get('title'))
                if(overlays.getLayers().item(i).get('title') == name[1]) {
                    consists = true;
                }
            }
            if(consists) {
                alert("Layer already exists!");
            } else {
                var layer_wms = new ol.layer.Image({
                title: name[1],
                source: new ol.source.ImageWMS({
                    url: 'http://localhost:8080/geoserver/wms',
                    params: {'LAYERS': layer_name},
                    ratio: 1,
                    serverType: 'geoserver'
                })});
                overlays.getLayers().push(layer_wms);
			
                var url = 'http://localhost:8080/geoserver/wms?request=getCapabilities';
                var parser = new ol.format.WMSCapabilities();

                $.ajax(url).then(function (response) {
                    var result = parser.read(response);
                    var Layers = result.Capability.Layer.Layer;
                    var extent;
                    for (var i = 0, len = Layers.length; i < len; i++) {
                        var layerobj = Layers[i];
                        if (layerobj.Name == layer_name) {
                            extent = layerobj.BoundingBox[0].extent;
                            map.getView().fit(extent,
                                { duration: 1590, size: map.getSize() }
                            );
                        }
                    }
                });
                layerSwitcher.renderPanel();
                legend()
            }
		}
	 	
        $(document).ready(function(){ $.ajax({
            type: "GET",
            url: "http://localhost:8080/geoserver/wfs?request=getCapabilities",
            dataType: "xml",
            success: function(xml) {
                var select = $('#layer');
                $(xml).find('FeatureType').each(function(){
                    var name = $(this).find('Name').text();
                    $(this).find('Name').each(function(){
                        var value = $(this).text();
                        select.append("<option class='ddindent' value='"+ value +"'>"+value+"</option>");
                    });
                });
            }
        });});

        $(document).ready(function(){ $.ajax({
            type: "GET",
            url: "http://localhost:8080/geoserver/wfs?request=getCapabilities",
            dataType: "xml",
            success: function(xml) {
                var select = $('#secondlayer');
                $(xml).find('FeatureType').each(function(){
                    var name = $(this).find('Name').text();
                    $(this).find('Name').each(function(){
                        var value = $(this).text();
                        select.append("<option class='ddindent' value='"+ value +"'>"+value+"</option>");
                    });
                });
            }
        });});

        $(function () {$("#layer" ).change(function () {
		    var attributes = document.getElementById("attributes");
            var length = attributes.options.length;
            for (i = length-1; i >= 0; i--) {
                attributes.options[i] = null;
            }
	        var value_layer = $(this).val();	
            attributes.options[0] = new Option('Select attributes', "");
			$(document).ready(function() {$.ajax({
				type: "GET",
				url: "http://localhost:8080/geoserver/wfs?service=WFS&request=DescribeFeatureType&version=1.1.0&typeName="+value_layer,
				dataType: "xml",
				success: function(xml) {
                    var select = $('#attributes');
                    $(xml).find('xsd\\:sequence').each(function() {
                        $(this).find('xsd\\:element').each(function() {
                        var value = $(this).attr('name');
                        var type = $(this).attr('type');
                        if (value != 'geom' && value != 'the_geom') {
                            select.append("<option class='ddindent' value='"+ type +"'>"+value+"</option>");
                        }});
                    });
				}
			});});
        });});

        $(function () {$("#layer" ).change(function () {
		    var attributestwo = document.getElementById("attributestwo");
            var length = attributestwo.options.length;
            for (i = length-1; i >= 0; i--) {
                attributestwo.options[i] = null;
            }
	        var value_layer = $(this).val();	
            attributestwo.options[0] = new Option('Select attributes', "");
			$(document).ready(function() {$.ajax({
				type: "GET",
				url: "http://localhost:8080/geoserver/wfs?service=WFS&request=DescribeFeatureType&version=1.1.0&typeName="+value_layer,
				dataType: "xml",
				success: function(xml) {
                    var select = $('#attributestwo');
                    $(xml).find('xsd\\:sequence').each(function() {
                        $(this).find('xsd\\:element').each(function() {
                        var value = $(this).attr('name');
                        var type = $(this).attr('type');
                        if (value != 'geom' && value != 'the_geom') {
                            select.append("<option class='ddindent' value='"+ type +"'>"+value+"</option>");
                        }});
                    });
				}
			});});
        });});

        $(function () {$("#secondlayer" ).change(function () {
		    var attributes = document.getElementById("secondattributes");
            var length = attributes.options.length;
            for (i = length-1; i >= 0; i--) {
                attributes.options[i] = null;
            }
	        var value_layer = $(this).val();	
            attributes.options[0] = new Option('Select attributes', "");
			$(document).ready(function() {$.ajax({
				type: "GET",
				url: "http://localhost:8080/geoserver/wfs?service=WFS&request=DescribeFeatureType&version=1.1.0&typeName="+value_layer,
				dataType: "xml",
				success: function(xml) {
                    var select = $('#secondattributes');
                    $(xml).find('xsd\\:sequence').each(function() {
                        $(this).find('xsd\\:element').each(function() {
                        var value = $(this).attr('name');
                        var type = $(this).attr('type');
                        if (value != 'geom' && value != 'the_geom') {
                            select.append("<option class='ddindent' value='"+ type +"'>"+value+"</option>");
                        }});
                    });
				}
			});});
        });});

        $(function () {$("#attributes" ).change(function () {
		    var operator = document.getElementById("operator");
            var length = operator.options.length;
            for (i = length-1; i >= 0; i--) {
                operator.options[i] = null;
            }
	        var value_type = $(this).val();
	        var value_attribute = $('#attributes option:selected').text();
            operator.options[0] = new Option('Select operator', "");
	        if (value_type == 'xsd:short' || value_type == 'xsd:int' || value_type == 'xsd:double') {
                var operator1 = document.getElementById("operator");
                operator1.options[1] = new Option('Greater than', '>');
                operator1.options[2] = new Option('Less than', '<');
                operator1.options[3] = new Option('Equal to', '=');
			} else if (value_type == 'xsd:string') {
			    var operator1 = document.getElementById("operator");
			    operator1.options[1] = new Option('Like', 'ILike');
			}
        });});

        $(function () {$("#attributestwo" ).change(function () {
		    var operatortwo = document.getElementById("operatortwo");
            var length = operatortwo.options.length;
            for (i = length-1; i >= 0; i--) {
                operatortwo.options[i] = null;
            }
	        var value_type = $(this).val();
	        var value_attribute = $('#attributestwo option:selected').text();
            operatortwo.options[0] = new Option('Select operator', "");
	        if (value_type == 'xsd:short' || value_type == 'xsd:int' || value_type == 'xsd:double') {
                var operator1 = document.getElementById("operatortwo");
                operator1.options[1] = new Option('Greater than', '>');
                operator1.options[2] = new Option('Less than', '<');
                operator1.options[3] = new Option('Equal to', '=');
			} else if (value_type == 'xsd:string') {
			    var operator1 = document.getElementById("operatortwo");
			    operator1.options[1] = new Option('Like', 'ILike');
			}
        });});

        $(function () {$("#secondattributes" ).change(function () {
		    var operator = document.getElementById("secondoperator");
            var length = operator.options.length;
            for (i = length-1; i >= 0; i--) {
                operator.options[i] = null;
            }
	        var value_type = $(this).val();
	        var value_attribute = $('#secondattributes option:selected').text();
            operator.options[0] = new Option('Select operator', "");
	        if (value_type == 'xsd:short' || value_type == 'xsd:int' || value_type == 'xsd:double') {
                var operator1 = document.getElementById("secondoperator");
                operator1.options[1] = new Option('Greater than', '>');
                operator1.options[2] = new Option('Less than', '<');
                operator1.options[3] = new Option('Equal to', '=');
			} else if (value_type == 'xsd:string') {
			    var operator1 = document.getElementById("secondoperator");
			    operator1.options[1] = new Option('Like', 'ILike');
			}
        });});

        var highlightStyle = new ol.style.Style({
            fill: new ol.style.Fill({
            color: 'rgba(255,255,255,0.7)',}),
            stroke: new ol.style.Stroke({
            color: '#3399CC',
            width: 3,}),
            image: new ol.style.Circle({
                radius: 10,
                fill: new ol.style.Fill({
                    color: '#3399CC'
                })
            })
        });

        featureOverlay = new ol.layer.Vector({
                source: new ol.source.Vector(),
                map: map,
                style: highlightStyle
        });

        function findRowNumber(cn1, v1) {
                var table = document.querySelector('#table');
                var rows = table.querySelectorAll("tr");
                var msg = "No such row exist"
                for(i=1;i<rows.length;i++) {
                    var tableData = rows[i].querySelectorAll("td");
                    if(tableData[cn1-1].textContent==v1) {
                        msg = i;
                        break;
                    }
                }
                return msg;
        }

        function addRowHandlers() {
            var rows = document.getElementById("table").rows;
            var heads = table.getElementsByTagName('th');
            var col_no;
            for (var i = 0; i < heads.length; i++) {
                var head = heads[i];
                if (head.innerHTML == 'id') {
                    col_no = i+1; 
                }
            }
            for (i = 0; i < rows.length; i++) {
                rows[i].onclick = function(){ return function() {
                    featureOverlay.getSource().clear();
		            $(function() {$("#table td").each(function() {
   	                    $(this).parent("tr").css("background-color", "white");
                        });
                    });
                    var cell = this.cells[col_no-1];
                    var id = cell.innerHTML;
			   	    $(document).ready(function () {
                        $("#table td:nth-child("+col_no+")").each(function () {
                            if ($(this).text() == id) {
                                $(this).parent("tr").css("background-color", "grey");
                            }
                        });
                    });

                    var features = geojson.getSource().getFeatures();
                    for (i=0; i< features.length; i++) {
                        if (features[i].getId() == id) {
                            featureOverlay.getSource().addFeature(features[i]);
                            featureOverlay.getSource().on('addfeature', function() {
                                map.getView().fit(
                                    featureOverlay.getSource().getExtent(),
                                    { duration: 1590, size: map.getSize() }
                                );
                            });
                        }
                    }
                };}
                (rows[i]);
            }
        }

        function  highlight(evt) {
		    featureOverlay.getSource().clear();
            var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                return feature;
            });
	  
            if (feature) {
                var geometry = feature.getGeometry();
                var coord = geometry.getCoordinates();
                var coordinate = evt.coordinate;	   
	            $(function() {$("#table td").each(function() {
   	                $(this).parent("tr").css("background-color", "white");
                });}); 
                featureOverlay.getSource().addFeature(feature);
            }
	
            var table = document.getElementById('table');
            var cells = table.getElementsByTagName('td');
            var rows = document.getElementById("table").rows;
            var heads = table.getElementsByTagName('th');
            var col_no;
            for (var i = 0; i < heads.length; i++) {
                var head = heads[i];
                if (head.innerHTML == 'id') {
                    col_no = i+1; 
                }
		    }
		    var row_no = findRowNumber(col_no, feature.getId());
		    var rows = document.querySelectorAll('#table tr');
            rows[row_no].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
			$(document).ready(function () {$("#table td:nth-child("+col_no+")").each(function () {
                if ($(this).text() == feature.getId()) {
                    $(this).parent("tr").css("background-color", "grey");           
                }
            });});
        };	

        function query() {
            $('#table').empty();
            if(geojson) {
		        map.removeLayer(geojson);
		    }
            if(featureOverlay) {
                featureOverlay.getSource().clear();
                map.removeLayer(featureOverlay);
            }	
            var layer = document.getElementById("layer");
            var value_layer = layer.options[layer.selectedIndex].value;
            var attribute = document.getElementById("attributes");
            var value_attribute = attribute.options[attribute.selectedIndex].text;
            var operator = document.getElementById("operator");
            var value_operator = operator.options[operator.selectedIndex].value;
            var txt = document.getElementById("value");
            var value_txt = txt.value;

            var attributetwo = document.getElementById("attributestwo");
            var value_attributetwo = attributetwo.options[attributetwo.selectedIndex].text;
            var operatortwo = document.getElementById("operatortwo");
            var value_operatortwo = operatortwo.options[operatortwo.selectedIndex].value;
            var txttwo = document.getElementById("valuetwo");
            var value_txttwo = txttwo.value;

            if (value_operator == 'ILike') {
			    value_txt = ""+value_txt+"%25";
			}
			else {
			    value_txt = value_txt;
			}

            if (value_operatortwo == 'ILike') {
			    value_txttwo = ""+value_txttwo+"%25";
			}
			else {
			    value_txttwo = value_txttwo;
			}

            if(value_attributetwo=="Select attributes") {
                var url = "http://localhost:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+value_layer+"&CQL_FILTER="+value_attribute+"+"+value_operator+"+'"+value_txt+"'&outputFormat=application/json"
            } else {
                var url = "http://localhost:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+value_layer+"&CQL_FILTER="+value_attribute+"+"+value_operator+"+'"+value_txt+"' AND "+value_attributetwo+"+"+value_operatortwo+"+'"+value_txttwo+"'&outputFormat=application/json"
            }
            var style = new ol.style.Style({
                fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.7)'}),
                stroke: new ol.style.Stroke({
                color: '#ffcc33',
                width: 3
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: '#ffcc33'
                    })
                })
            });
            geojson = new ol.layer.Vector({
                source: new ol.source.Vector({
		            url: url,
                    format: new ol.format.GeoJSON()
                }),
		        style: style,
            });
		    geojson.getSource().on('addfeature', function() {
                map.getView().fit(geojson.getSource().getExtent(),
                    { duration: 1590, size: map.getSize() });
            });
		    map.addLayer(geojson);
		    $.getJSON(url, function(data) {
	            var col = [];
	            col.push('id');
                for (var i = 0; i < data.features.length; i++) {
                    for (var key in data.features[i].properties) {
                        if (col.indexOf(key) === -1) {
                            col.push(key);
                        }
                    }
                }
	            var table = document.createElement("table");  
                table.setAttribute("class", "table table-bordered");
                table.setAttribute("id", "table");
                var tr = table.insertRow(-1);             
                for (var i = 0; i < col.length; i++) {
                    var th = document.createElement("th");  
                    th.innerHTML = col[i];
                    tr.appendChild(th);
                }
                for (var i = 0; i < data.features.length; i++) {
                    tr = table.insertRow(-1);
                    for (var j = 0; j < col.length; j++) {
                        var tabCell = tr.insertCell(-1);
				        if (j == 0) {
                            tabCell.innerHTML = data.features[i]['id'];
                        } else {
                            tabCell.innerHTML = data.features[i].properties[col[j]];
				        }
                    }
                }
                var divContainer = document.getElementById("table_data");
                divContainer.innerHTML = "";
                divContainer.appendChild(table);
		        addRowHandlers();
		
                document.getElementById('map').style.height='75%';
                document.getElementById('table_data').style.height='25%';
	            map.updateSize();
            });
	        map.on('click', highlight);
            addRowHandlers();
        }

        function query_multiple() {
            $('#table').empty();
            if(geojson) {
		        map.removeLayer(geojson);
		    }
            if(featureOverlay) {
                featureOverlay.getSource().clear();
                map.removeLayer(featureOverlay);
            }	
            var layer = document.getElementById("layer");
            var value_layer = layer.options[layer.selectedIndex].value;
            var attribute = document.getElementById("attributes");
            var value_attribute = attribute.options[attribute.selectedIndex].text;
            var operator = document.getElementById("operator");
            var value_operator = operator.options[operator.selectedIndex].value;
            var txt = document.getElementById("value");
            var value_txt = txt.value;

            var layer_second = document.getElementById("secondlayer");
            var value_layer_second = layer_second.options[layer_second.selectedIndex].value;
            var attribute_second = document.getElementById("secondattributes");
            
            var includes = false;
            for (var i = 0; i < attribute_second.options.length; i++) {
                if(attribute_second.options[i].text == value_attribute) {
                    includes = true;
                }
            }
            console.log(includes)
            if(!includes) {
                alert("Second layer does not have attribute " + value_attribute + "!");
            } else {
                if (value_operator == 'ILike') {
                    value_txt = ""+value_txt+"%25";
                }
                else {
                    value_txt = value_txt;
                }
                var url = "http://localhost:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+value_layer+","+value_layer_second+"&CQL_FILTER="+value_attribute+"+"+value_operator+"+'"+value_txt+"'&outputFormat=application/json"
                var style = new ol.style.Style({
                    fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 0.7)'}),
                    stroke: new ol.style.Stroke({
                    color: '#ffcc33',
                    width: 3
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                });
                geojson = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        url: url,
                        format: new ol.format.GeoJSON()
                    }),
                    style: style,
                });
                geojson.getSource().on('addfeature', function() {
                    map.getView().fit(geojson.getSource().getExtent(),
                        { duration: 1590, size: map.getSize() });
                });
                map.addLayer(geojson);
                $.getJSON(url, function(data) {
                    var col = [];
                    col.push('id');
                    for (var i = 0; i < data.features.length; i++) {
                        for (var key in data.features[i].properties) {
                            if (col.indexOf(key) === -1) {
                                col.push(key);
                            }
                        }
                    }
                    var table = document.createElement("table");  
                    table.setAttribute("class", "table table-bordered");
                    table.setAttribute("id", "table");
                    var tr = table.insertRow(-1);             
                    for (var i = 0; i < col.length; i++) {
                        var th = document.createElement("th");  
                        th.innerHTML = col[i];
                        tr.appendChild(th);
                    }
                    for (var i = 0; i < data.features.length; i++) {
                        tr = table.insertRow(-1);
                        for (var j = 0; j < col.length; j++) {
                            var tabCell = tr.insertCell(-1);
                            if (j == 0) {
                                tabCell.innerHTML = data.features[i]['id'];
                            } else {
                                tabCell.innerHTML = data.features[i].properties[col[j]];
                            }
                        }
                    }
                    var divContainer = document.getElementById("table_data");
                    divContainer.innerHTML = "";
                    divContainer.appendChild(table);
                    addRowHandlers();
            
                    document.getElementById('map').style.height='75%';
                    document.getElementById('table_data').style.height='25%';
                    map.updateSize();
                });
                map.on('click', highlight);
                addRowHandlers();
            }
        }

        function clear_all() {
		    document.getElementById('map').style.height='100%';
            document.getElementById('table_data').style.height='0%';
            map.updateSize();
	        $('#table').empty();
	        if (geojson) {
                geojson.getSource().clear(); map.removeLayer(geojson);
            }
	        if (featureOverlay) {
                featureOverlay.getSource().clear(); map.removeLayer(featureOverlay);
            }
		    map.removeInteraction(draw);
            if (vectorLayer) {
                vectorLayer.getSource().clear();
            }
            map.removeOverlay(helpTooltip);
		    map.un('singleclick', getinfo);
	        overlay.setPosition(undefined);
            closer.blur();
            map.un('click', highlight);
		}

        </script>
    </body>
</html>